import streamlit as st
from streamlit_js_eval import get_geolocation
import urllib.parse

st.set_page_config(page_title="SOS System", page_icon="üö®")
st.title("üö® ‡∏£‡∏∞‡∏ö‡∏ö SOS ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß")

# 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
location = get_geolocation()

if location:
    lat = location['coords']['latitude']
    lon = location['coords']['longitude']
    accuracy = location['coords'].get('accuracy')
    
    st.success(f"‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: {accuracy} ‡πÄ‡∏°‡∏ï‡∏£)")
    
    # 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ Maps ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
    # ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ?q= ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏±‡∏Å‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏û‡∏≠‡∏î‡∏µ
    maps_link = f"https://www.google.com/maps?q={lat},{lon}"
    st.markdown(f"### [üìç ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà]({maps_link})")
    
    # 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á LINE
    # ‡πÉ‡∏™‡πà Line ID ‡∏Ç‡∏≠‡∏á Bot ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ @ (‡πÄ‡∏ä‡πà‡∏ô abc1234)
    line_bot_id = "‡∏ï‡∏≠‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ" 
    msg = f"üÜò ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏î‡πà‡∏ß‡∏ô!\nüìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î: {maps_link}\nüåê Lat/Lon: {lat}, {lon}"
    encoded_msg = urllib.parse.quote(msg)
    
    # ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó LINE OA ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ
    line_url = f"https://line.me/R/oaMessage/{line_bot_id}/?{encoded_msg}"
    
    # 4. ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏™‡πà‡∏á (‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô)
    st.markdown(f"""
        <a href="{line_url}" target="_blank" style="text-decoration: none;">
            <div style="
                background-color: #06C755;
                color: white;
                padding: 20px;
                text-align: center;
                border-radius: 15px;
                font-size: 24px;
                font-weight: bold;
                box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
                margin-top: 20px;">
                üü¢ ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            </div>
        </a>
    """, unsafe_allow_html=True)

    with st.expander("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"):
        st.write(f"Latitude: {lat}")
        st.write(f"Longitude: {lon}")

else:
    st.warning("‚ö†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...")
    st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (Allow)' ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ URL ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ https://")
